{{navbar}}
<div id="master-panel">
  <h1>Master Panel</h1>
  <div class="master-panel-container">
    <section class="master-panel-admins">
      <div class="master-panel-header">
        <h2>Admins</h2>
        <button class="button-admin" id="toggle-overlay">Add Admin</button>
      </div>
      <hr />
      <ul></ul>
    </section>
    <section class="master-panel-routes">
      <h2>Routes</h2>
      <ul>
        <li>
          <div class="left">
            <h4>Main Route</h4>
          </div>
          <div class="right">
            <h4>Changed Route</h4>
          </div>
        </li>
        <hr />
      </ul>
    </section>

    <section class="master-panel-data">
      <div class="master-panel-header">
        <h2>User Data</h2>
        <a class="button-admin" href="/master-panel/users" data-link
          >View All</a
        >
      </div>
      <ul>
        <li>
          <div class="left">
            <h4>IP Address</h4>
          </div>
          <div class="center">
            <h4>Country</h4>
          </div>
          <div class="right">
            <h4>Internet Provider</h4>
          </div>
        </li>
        <hr />
      </ul>
    </section>
  </div>
</div>
{{footer}}

<div class="master-panel-overlay" id="master-panel-overlay">
  <div class="master-panel-modal">
    <h2>Add Admin</h2>
    <hr />
    <label for="admin-name">Admin Username</label>
    <input
      type="text"
      placeholder="Admin Username"
      id="admin-name"
      name="admin-name"
    />
    <label for="admin-password">Admin Password</label>
    <input
      type="password"
      placeholder="Admin Password"
      id="admin-password"
      name="admin-password"
    />
    <label for="admin-confirm-password">Confirm Password</label>
    <input
      type="password"
      placeholder="Confirm Password"
      id="admin-confirm-password"
      name="admin-confirm-password"
    />
    <button class="button-admin" id="add-admin">Add Admin</button>
  </div>
</div>

<div class="master-panel-overlay" id="master-panel-confirm">
  <div class="master-panel-modal confirm-remove">
    <p>Are you sure you want to remove admin <span id="set-user"></span>?</p>
    <div>
      <button class="button-admin btn-secondary" id="remove-admin">
        Remove Admin
      </button>
      <button class="button-admin btn-primary" id="cancel-remove">
        Cancel
      </button>
    </div>
  </div>
</div>

<script>
  document.querySelector("#toggle-overlay").addEventListener("click", () => {
    document.querySelector("#master-panel-overlay").classList.toggle("show");
  });

  fetch("/api/routes/getInitalUserData.php").then((response) => {
    response.json().then((res) => {
      const userData = res.data;

      const userDataList = document.querySelector(".master-panel-data ul");

      userData.forEach((data) => {
        const userDataItem = document.createElement("li");
        userDataItem.innerHTML = `
          <div class="left">
            <p>${data.ip}</p>
          </div>
          <div class="center">
            <p>${data.country}</p>
          </div>
          <div class="right">
            <p>${data.isp}</p>
          </div>
        `;

        userDataList.appendChild(userDataItem);
      });
    });
  });

  fetch("/api/routes/router.php")
    .then((response) =>
      response.json().then((res) => {
        const routes = res.data;

        const routeList = document.querySelector(".master-panel-routes ul");

        routes.forEach((route) => {
          const routeItem = document.createElement("li");
          routeItem.classList.add("route-item");
          routeItem.innerHTML = `
          <div class="left">
            <p>${route.route}</p>
          </div>
          <div class="center">
            <i class="fa-solid fa-arrow-right"></i>
          </div>
          <div class="right">
            <div class="route-item-input">
              <input type="text" value="${route.changedRoute}" />
              <button class="button-admin">Save</button>
            </div>
          </div>
        `;

          routeList.appendChild(routeItem);
        });

        document.querySelectorAll(".route-item button").forEach((button) => {
          button.addEventListener("click", (e) => {
            const route =
              e.target.parentElement.parentElement.parentElement
                .firstElementChild.innerText;
            const changedRoute = e.target.previousElementSibling.value;

            console.log(route, changedRoute);

            const splitRoute = route.split("/");
            const splitChangedRoute = changedRoute.split("/");

            if (splitRoute.length !== splitChangedRoute.length) {
              alert("Route paths must be the same length!");
              return;
            }

            const formData = new FormData();

            formData.append("route", route);
            formData.append("changedRoute", changedRoute);

            fetch("/api/routes/updateRoute.php", {
              method: "POST",
              body: formData,
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  e.target.innerText = "Saved!";
                  e.target.style.backgroundColor = "gray";

                  setTimeout(() => {
                    e.target.innerText = "Save";
                    e.target.style.backgroundColor = "green";
                  }, 2000);
                } else {
                  alert("Failed to update route!");
                }
              })
              .catch((error) => console.error("Error updating route:", error));
          });
        });
      })
    )
    .catch((error) => console.error("Error fetching routes:", error));

  document.querySelector("#add-admin").addEventListener("click", () => {
    const adminName = document.querySelector("#admin-name");
    const adminPassword = document.querySelector("#admin-password");
    const adminConfirmPassword = document.querySelector(
      "#admin-confirm-password"
    );

    if (
      !adminName.value.trim() ||
      !adminPassword.value.trim() ||
      !adminConfirmPassword.value.trim()
    ) {
      alert("Please fill in all fields!");
      return;
    }

    if (adminPassword.value.trim() !== adminConfirmPassword.value.trim()) {
      alert("Passwords do not match!");
      return;
    }

    const formData = new FormData();
    formData.append("username", adminName.value);
    formData.append("password", adminPassword.value);
    formData.append("confirm_password", adminConfirmPassword.value);

    const saveAdmin = addAdmin(formData);

    if (!saveAdmin) {
      alert("Failed to add admin!");
      return;
    }

    appendAdmin({
      username: adminName.value,
      changed: false,
    });

    adminName.value = "";
    adminPassword.value = "";
    adminConfirmPassword.value = "";
    document.querySelector("#master-panel-overlay").classList.remove("show");
  });

  async function addAdmin(formData) {
    const response = await fetch("/api/routes/register.php", {
      method: "POST",
      body: formData,
    });

    const data = await response.json();

    if (data.success) {
      return true;
    } else {
      return false;
    }
  }

  async function getAdminList() {
    const response = await fetch("/api/routes/admins.php");
    const data = await response.json();

    if (data.success) {
      data.users.forEach((admin) => {
        appendAdmin(admin);
      });
    }
  }

  function appendAdmin({ username, changed }) {
    const adminList = document.querySelector(".master-panel-admins ul");
    const admin = document.createElement("li");

    if (changed) {
      admin.innerHTML = `
      <div>
        <i class="fa-solid fa-x border-fa"></i>
        <p>${username}</p>
      </div>
      <p class="success">Active</p>
    `;
    } else {
      admin.innerHTML = `
      <div>
        <i class="fa-solid fa-x border-fa"></i>
        <p>${username}</p>
      </div>
      <p class="pending">Pending</p>
    `;
    }

    adminList.appendChild(admin);
  }

  document
    .querySelector(".master-panel-admins ul")
    .addEventListener("click", (e) => {
      if (e.target.classList.contains("fa-x")) {
        const username = e.target.nextElementSibling.innerText;

        document.querySelector("#set-user").innerText = username;
        document.querySelector("#master-panel-confirm").classList.add("show");

        document
          .querySelector("#remove-admin")
          .addEventListener("click", () => {
            removeAdmin(username);
            document
              .querySelector("#master-panel-confirm")
              .classList.remove("show");
            e.target.parentElement.parentElement.remove();
          });

        document
          .querySelector("#cancel-remove")
          .addEventListener("click", () =>
            document
              .querySelector("#master-panel-confirm")
              .classList.remove("show")
          );

        return;
      }
    });

  function removeAdmin(username) {
    const userData = new FormData();
    userData.append("username", username);

    fetch("/api/routes/removeAdmin.php", {
      method: "POST",
      body: userData,
    })
      .then((response) => response.json())
      .then((data) => {
        if (!data.success) {
          alert("Failed to remove admin!");
        }
      })
      .catch((error) => {
        console.error("Error removing admin:", error);
      });
  }

  getAdminList();
</script>

<style>
  #master-panel {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    margin: 10em auto;
    min-height: 100vh;
  }

  #master-panel h1 {
    font-size: 2em;
    margin-bottom: 1em;
  }

  .master-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 0.5em;
  }

  .master-panel-routes h2 {
    margin-bottom: 0.5em;
  }

  .button-admin {
    padding: 0.5em 1em;
    background-color: green;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  .master-panel-container {
    display: flex;
    justify-content: center;
    align-self: center;
    flex-direction: column;
    width: 80%;
    margin: 0 auto;
  }

  .master-panel-container section {
    flex-grow: 1;
    margin: 1em 0;
    border: 1px solid gray;
    border-radius: 5px;
    padding: 1em;
  }

  .master-panel-container section ul {
    padding-top: 1em;
  }

  .master-panel-container section ul li {
    padding: 0.5em 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 60px;
  }

  .master-panel-container section ul li div {
    display: flex;
    align-items: center;
    gap: 1em;
    width: 100%;
  }

  .border-fa {
    border-right: 1px solid gray;
    padding-right: 1em;
    cursor: pointer;
  }

  .master-panel-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 100;
    justify-content: center;
    align-items: center;
  }

  .master-panel-modal {
    background-color: white;
    padding: 1.5em;
    border-radius: 5px;
  }

  .master-panel-modal hr {
    margin: 0.5em 0;
  }

  .master-panel-modal input {
    width: 100%;
    padding: 0.5em 1em;
    border: 1px solid gray;
    margin-bottom: 1em;
    border-radius: 5px;
  }

  .master-panel-modal button {
    padding: 0.5em 1em;
    background-color: green;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    float: right;
  }

  .left {
    display: flex;
    justify-content: flex-start;
    width: 100%;
    align-items: center;
  }

  .right {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    width: 100%;
  }

  .center {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
  }

  .btn-primary {
    background-color: grey !important;
  }

  .btn-secondary {
    background-color: red !important;
    margin-left: 1em;
  }

  .confirm-remove p {
    margin-bottom: 1em;
  }

  .confirm-remove p span {
    font-weight: bold;
    color: red;
  }

  .pending {
    color: #ffd500;
  }

  .success {
    color: green;
  }

  .show {
    display: flex;
  }

  .route-item-input {
    display: flex;
    align-items: center;
    gap: 1em;
  }

  .route-item-input input {
    border: none;
    border-bottom: 1px solid gray;
    width: 100%;
    font-size: 1em;
  }
</style>
